define(["q","knockout","postal"],function(t,e,i){var n=function(t){this.message=t;this.name="DuplicateViewRegistrationException"};var o=function(t){this.message=t;this.name="UnregisteredViewWarning"};var r=function(t){this.message=t;this.name="MissingViewModelException"};var a=function(t){this.message=t;this.name="MissingDOMElementException"};var s=function(t){this.message=t;this.name="ViewLoadedException"};var l=function(t){this.message=t;this.name="MissingOptionException"};var c=function(t){this.network=i.channel("galaxy");this.viewmodelDirectory="/app/viewmodel";this.viewDirectory="/app/view";this.federation=[];this.currentLocation=null;this.StarChart=this.StarChartConstructor()};c.prototype.route=function(t){var e={pattern:t,viewmodelId:null,callback:null};return{to:function(t){e.viewmodelId=t;this.StarChart.addRoute(e);return{then:function(t){e.callback=t;this.StarChart.updateRoute(e)}.bind(this)}}.bind(this)}};c.prototype.warp=function(){var t={};var e=function(){this.StarChart.warp(t)}.bind(this);return{to:function(i){t.location=i;return{engage:e,with:function(i){t.payload=i;return{engage:e}}}}}};c.prototype.addRoute=function(t,e,i){this.StarChart.addRoute(t,e,i)};c.prototype.create=function(t){if(t){this.setOptions(t)}requirejs.onError=function t(e){console.error(new r("Unable to find the location of `"+this.currentLocation+".js`. "+e.message))}.bind(this);this.StarChart.scan();window.addEventListener("popstate",function t(e){this.StarChart.scan()}.bind(this))};c.prototype.setOptions=function(t){if(t&&t.hasOwnProperty("channel")&&t.channel!==""){this.network=i.channel(t.channel)}if(t&&t.hasOwnProperty("viewmodelDirectory")){this.viewmodelDirectory=t.viewmodelDirectory}if(t&&t.hasOwnProperty("viewDirectory")){this.viewDirectory=t.viewDirectory}};c.prototype.getDOMElements=function(t){var e=t.substr(0,1)==="."?"class":"id";var i=t.replace(/[\.#]/,"");var n=[];if(e==="class"){var o=document.getElementsByClassName(i);if(o.length){for(var r in o){if(typeof o[r]==="object"){n[n.length]=o[r]}}}}else if(e==="id"){n[n.length]=document.getElementById(i)}if(n[n.length-1]===null){throw new a("The DOM element you specified ("+t+") for view model `"+this.currentLocation+"` was not found.")}return n};c.prototype.loadViewModel=function(e){var i=t.defer();var n=this.federation.filter(function(t){return t.id===e})[0];if(!n){console.warn(new o("Location with id `"+e+"` has not joined the federation. Attempting to join in now."));require([this.viewmodelDirectory+"/"+e+".js"],function t(e){this.join(e);i.resolve(e)}.bind(this))}else{i.resolve(n)}return i.promise};c.prototype.join=function(t){if(!t.hasOwnProperty("__joined")){if(t.hasOwnProperty("children")&&t.children.length>0){t.children.map(function(e){e.__parent=t.id})}if(!t.hasOwnProperty("__loaded")){t.__loaded=false}if(!t.hasOwnProperty("show")){t.show=function(){this.render(viewModel.id)}.bind(this)}t.__joined=true;this.federation.push(t);this.network.publish(t.id+".joined")}else{if(!t.hasOwnProperty("__parent")){console.warn("The view model with id `"+t.id+"` has already joined the federation.")}}};c.prototype.leave=function(t){var e=_.findWhere(this.federation,{id:t});if(e){this.federation=_.filter(this.federation,function(e){e.id!==t})}};c.prototype.loadTemplate=function(i){var n=t.defer();var o=this.federation.filter(function(t){return t.id===i})[0];if(o){if(!o.__loaded){var r=[this.viewDirectory,"/",o.templatePath].join("");this.getDOMElements(o.domBindingId).forEach(function(t){var i=new XMLHttpRequest;i.open("GET",r,true);i.onloadend=function i(r){if(r.target.status===200||r.target.status===302){t.innerHTML=r.target.responseText;e.applyBindings(o,t);o.__loaded=true;this.network.publish(o.id+".bound");n.resolve()}}.bind(this);i.send()}.bind(this))}else{this.network.publish(o.id+".bound");n.resolve()}}return n.promise};c.prototype.hideInactiveViews=function(t){this.federation.forEach(function(e){if(!e.autoRender&&e.id!==t){this.getDOMElements(e.domBindingId).forEach(function(t){t.style.display="none"})}}.bind(this))};c.prototype.render=function(t,e){var i=null;this.loadViewModel(t).then(function(e){i=e;this.hideInactiveViews(t);return this.loadTemplate(t)}.bind(this)).then(function(){this.getDOMElements(i.domBindingId).forEach(function(t){t.style.display=""});this.network.publish(i.id+".docked",e);if(i.hasOwnProperty("children")){i.children.map(function(t){this.render(t.id)})}}.bind(this)).fail(function(t){console.error(t)}).catch(function(t){console.error(t)}).finally(function(){})};c.prototype.StarChartConstructor=function(){var t=this;var e=function(){this.routes=[];this.currentLocation=null;this.smuggledPayload=null};e.prototype.updateRoute=function(t){var e=this.routes.filter(function(e){return e.pattern===t.pattern})[0];e.callback=t.callback};e.prototype.addRoute=function(t){this.routes[this.routes.length]={pattern:t.pattern,viewModel:t.viewmodelId,callback:t.callback};return this.routes};e.prototype.warp=function(t){var e=[];var i;var n;try{if(t&&typeof t==="string"){n=t}else if(t&&typeof t==="object"&&!t.hasOwnProperty("location")){throw new l("You must provide a location property and a payload property when publishing the `transport` event with an object parameter.")}else if(t&&typeof t==="object"&&t.hasOwnProperty("location")){n=t.location}i=this.routes.filter(function(t){return t.pattern===n})[0];e[e.length]=n;if(t.hasOwnProperty("payload")&&t.payload){this.smuggledPayload=t.payload}window.location.hash=e.join("")}catch(t){console.error(t)}return i};e.prototype.scan=function(e){var this=this;var i={};var n,o,r;var a=location.hash.split("#")[1]||"";n=a;if(a!==""){o=a.split("/");n=o[0];o.splice(0,1)}var s=this.routes.filter(function(t){return t.pattern.split("/")[0]===n})||false;if(s){s=s.filter(function(t){return a.split("/").length===t.pattern.split("/").length})||false}if(s&&s.length&&o&&o.length){var l=s[0].pattern.split("/");l.splice(0,1);for(var c=0,h=l.length;c<=h,arg=l[c];c+=1){if(arg.substr(0,1)===":"){i[arg.substr(1,arg.length-1)]=o[c]}}}if(s&&s.length){for(var d in this.smuggledPayload){i[d]=this.smuggledPayload[d]}t.render(s[0].viewModel,i);if(s[0].callback!==null){s[0].callback.call()}}};return new e};c.prototype.depot=function(){var i=function(){this.collection=e.observableArray();this.proxy=null;this._dirty=false};i.prototype.populate=function(e){var i=t.defer();var this=this;if(!this._dirty&&this.collection().length&&!e){i.resolve()}else if(!this._dirty||e){this.proxy.load().then(function(t){this.collection(t);i.resolve()}.bind(this)).fail(function(t){console.log("Failed to load from remote proxy. "+t.toString());i.reject()}).done()}else{i.reject()}return i.promise};i.prototype.isDirty=function(){return this._dirty};i.prototype.sync=function(){this.collection.forEach(function(t){if(t.hasOwnProperty("_local")&&t._local){this.proxy.save(t).then(function(){t._local=false}).fail(function(t){console.error(t)}).done()}}.bind(this))};i.prototype.add=function(t){if(t instanceof Array){t.forEach(function(t){this.collection.push(t)}.bind(this))}else{this.collection.push(t)}};i.prototype.empty=function(){this.collection.removeAll()};i.prototype.remove=function(t){var e=this.collection().filter(function(e){return JSON.stringify(e)!==JSON.stringify(t)});this.collection(e)};i.prototype.removeById=function(t){var e=this.collection().filter(function(e){return e.id!==t});this.collection(e)};return new i};return new c});
//# sourceMappingURL=./galaxy.map