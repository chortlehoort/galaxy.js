define(["q","knockout","postal"],function(t,e,i){var n=function(t){this.message=t;this.name="DuplicateViewRegistrationException"};var o=function(t){this.message=t;this.name="UnregisteredViewWarning"};var r=function(t){this.message=t;this.name="MissingViewModelException"};var a=function(t){this.message=t;this.name="MissingDOMElementException"};var s=function(t){this.message=t;this.name="ViewLoadedException"};var l=function(t){this.message=t;this.name="MissingOptionException"};var c=function(t){this.network=i.channel("galaxy");this.viewmodelDirectory="/app/viewmodel";this.viewDirectory="/app/view";this.federation=[];this.blackHoles=[];this.currentLocation=null;this.StarChart=this.StarChartConstructor()};c.prototype.route=function(t){var e={pattern:t,viewmodelId:null,callback:null};return{to:function(t){e.viewmodelId=t;this.StarChart.addRoute(e);return{then:function(t){e.callback=t;this.StarChart.updateRoute(e)}.bind(this)}}.bind(this)}};c.prototype.warp=function(){var t={};var e=function(){this.StarChart.warp(t)}.bind(this);return{to:function(i){t.location=i;return{engage:e,with:function(i){t.payload=i;return{engage:e}}}}}};c.prototype.addRoute=function(t,e,i){this.StarChart.addRoute(t,e,i)};c.prototype.static=function(t){this.blackHoles[this.blackHoles.length]=t};c.prototype.create=function(t){if(t){this.setOptions(t)}requirejs.onError=function(t){console.error(new r("Unable to find the location of `"+this.currentLocation+".js`. "+t.message))}.bind(this);this.StarChart.scan();window.addEventListener("popstate",function(t){this.StarChart.scan()}.bind(this))};c.prototype.setOptions=function(t){if(t&&t.hasOwnProperty("channel")&&t.channel!==""){this.network=i.channel(t.channel)}if(t&&t.hasOwnProperty("viewmodelDirectory")){this.viewmodelDirectory=t.viewmodelDirectory}if(t&&t.hasOwnProperty("viewDirectory")){this.viewDirectory=t.viewDirectory}};c.prototype.getDOMElements=function(t){var e=t.substr(0,1)==="."?"class":"id";var i=t.replace(/[\.#]/,"");var n=[];if(e==="class"){var o=document.getElementsByClassName(i);if(o.length){for(var r in o){if(typeof o[r]==="object"){n[n.length]=o[r]}}}}else if(e==="id"){n[n.length]=document.getElementById(i)}if(n[n.length-1]===null){throw new a("The DOM element you specified ("+t+") for view model `"+this.currentLocation+"` was not found.")}return n};c.prototype.loadViewModel=function(e){var i=t.defer();var n=this.federation.filter(function(t){return t.id===e})[0];if(!n){console.warn(new o("Location with id `"+e+"` has not joined the federation. Attempting to join in now."));require([this.viewmodelDirectory+"/"+e+".js"],function(t){this.join(t);i.resolve(t)}.bind(this))}else{i.resolve(n)}return i.promise};c.prototype.join=function(t){if(!t.hasOwnProperty("__joined")){if(t.hasOwnProperty("children")&&t.children.length>0){t.children.map(function(e){e.__parent=t.id})}if(!t.hasOwnProperty("__loaded")){t.__loaded=false}if(!t.hasOwnProperty("show")){t.show=function(){this.render(viewModel.id)}.bind(this)}t.__joined=true;this.federation.push(t);this.network.publish(t.id+".joined")}else{if(!t.hasOwnProperty("__parent")){console.warn("The view model with id `"+t.id+"` has already joined the federation.")}}};c.prototype.leave=function(t){var e=_.findWhere(this.federation,{id:t});if(e){this.federation=_.filter(this.federation,function(e){e.id!==t})}};c.prototype.loadTemplate=function(i){var n=t.defer();var o=this.federation.filter(function(t){return t.id===i})[0];if(o){if(!o.__loaded){var r=[this.viewDirectory,"/",o.templatePath].join("");this.getDOMElements(o.domBindingId).forEach(function(t){var i=new XMLHttpRequest;i.open("GET",r,true);i.onloadend=function(i){if(i.target.status===200||i.target.status===302){t.innerHTML=i.target.responseText;e.applyBindings(o,t);o.__loaded=true;this.network.publish(o.id+".bound");n.resolve(o)}}.bind(this);i.send()}.bind(this))}else{this.network.publish(o.id+".bound");n.resolve(o)}}return n.promise};c.prototype.hideInactiveViews=function(t){this.federation.forEach(function(e){if(!e.autoRender&&e.id!==t.id){this.getDOMElements(e.domBindingId).forEach(function(t){t.style.display="none"})}}.bind(this));return t};c.prototype.renderChildren=function(e){var i=t.defer();if(e.hasOwnProperty("children")){e.children.map(function(t){this.render(t.id)}.bind(this))}return i.promise};c.prototype.showRoutedView=function(t,e){this.getDOMElements(t.domBindingId).forEach(function(t){t.style.display=""});this.network.publish(t.id+".docked",e)};c.prototype.render=function(t,e){var i=null;this.loadViewModel(t).then(function(t){this.hideInactiveViews(t);this.loadTemplate(t.id).then(function(t){this.renderChildren(t);this.showRoutedView(t,e)}.bind(this))}.bind(this)).fail(function(t){console.error(t)}).catch(function(t){console.error(t)})};c.prototype.StarChartConstructor=function(){var t=this;var e=function(){this.routes=[];this.currentLocation=null;this.smuggledPayload=null};e.prototype.updateRoute=function(t){var e=this.routes.filter(function(e){return e.pattern===t.pattern})[0];e.callback=t.callback};e.prototype.addRoute=function(t){this.routes[this.routes.length]={pattern:t.pattern,viewModel:t.viewmodelId,callback:t.callback};return this.routes};e.prototype.warp=function(t){var e=[];var i;var n;try{if(t&&typeof t==="string"){n=t}else if(t&&typeof t==="object"&&!t.hasOwnProperty("location")){throw new l("You must provide a location property and a payload property when publishing the `transport` event with an object parameter.")}else if(t&&typeof t==="object"&&t.hasOwnProperty("location")){n=t.location}i=this.routes.filter(function(t){return t.pattern===n})[0];e[e.length]=n;if(t.hasOwnProperty("payload")&&t.payload){this.smuggledPayload=t.payload}history.pushState(null,null,e.join(""));this.scan()}catch(t){console.error(t)}return i};e.prototype.scan=function(e){var i=this;var n={};var o,r,a;var s=location.pathname.split("/")[1];o=s;if(s!==""){r=s.split("/");o=r[0];r.splice(0,1)}var l=i.routes.filter(function(t){return t.pattern.split("/")[0]===o})||false;if(l){l=l.filter(function(t){return s.split("/").length===t.pattern.split("/").length})||false}if(l&&l.length&&r&&r.length){var c=l[0].pattern.split("/");c.splice(0,1);for(var h=0,d=c.length;h<=d,arg=c[h];h+=1){if(arg.substr(0,1)===":"){n[arg.substr(1,arg.length-1)]=r[h]}}}if(l&&l.length){for(var u in i.smuggledPayload){n[u]=i.smuggledPayload[u]}for(var f in t.blackHoles){t.render(t.blackHoles[f])}for(var p in l){var y=l[p];t.render(y.viewModel,n);if(y.callback!==null){y.callback.call()}}}};return new e};c.prototype.depot=function(){var i=function(){this.collection=e.observableArray();this.proxy=null;this._dirty=false};i.prototype.populate=function(e){var i=t.defer();if(!this._dirty&&this.collection().length&&!e){i.resolve()}else if(!this._dirty||e){this.proxy.load().then(function(t){this.collection(t);i.resolve()}.bind(this)).fail(function(t){console.log("Failed to load from remote proxy. "+t.toString());i.reject()}).done()}else{i.reject()}return i.promise};i.prototype.isDirty=function(){return this._dirty};i.prototype.sync=function(){this.collection.forEach(function(t){if(t.hasOwnProperty("_local")&&t._local){this.proxy.save(t).then(function(){t._local=false}.bind(this)).fail(function(t){console.error(t)}).done()}})};i.prototype.add=function(t){if(t instanceof Array){t.forEach(function(t){this.collection.push(t)}.bind(this))}else{this.collection.push(t)}};i.prototype.empty=function(){this.collection.removeAll()};i.prototype.remove=function(t){var e=this.collection().filter(function(e){return JSON.stringify(e)!==JSON.stringify(t)});this.collection(e)};i.prototype.removeById=function(t){var e=this.collection().filter(function(e){return e.id!==t});this.collection(e)};return new i};return new c});
//# sourceMappingURL=./build/galaxy.map