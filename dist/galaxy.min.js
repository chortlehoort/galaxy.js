define(function(require){var Q=require("q"),ko=require("knockout"),postal=require("postal"),t=function(){this.network=postal.channel("galaxy"),this.viewmodelDirectory="/app/viewmodel",this.viewDirectory="/app/view",this.federation=[],this.blackHoles=[],this.currentLocation=null,this.Starship=new e};t.prototype.route=function(t){var e={pattern:t,viewmodelId:null,callback:null};return{to:function(t){return e.viewmodelId=t,this.Starship.addRoute(e),{then:function(t){e.callback=t,this.Starship.updateRoute(e)}.bind(this)}}.bind(this)}},t.prototype.warp=function(){var t={},e=function(){this.Starship.warp(t),this.scan()}.bind(this);return{to:function(n){return t.location=n,{engage:e,with:function(n){return t.payload=n,{engage:e}}}}}},t.prototype.addRoute=function(t,e,n){this.Starship.addRoute(t,e,n)},t.prototype.static=function(t){this.blackHoles[this.blackHoles.length]=t},t.prototype.create=function(t){t&&this.setOptions(t),requirejs.onError=function(t){console.error(new i("Unable to find the location of `"+this.currentLocation+".js`. "+t.message))}.bind(this),this.scan(),window.addEventListener("popstate",function(){this.scan()}.bind(this))},t.prototype.scan=function(){var t=this.Starship.scan(),e=this.Starship.getPayload();if(t&&t.length){for(var n in this.blackHoles)this.render(this.blackHoles[n]);for(var i in t){var o=t[i];this.render(o.viewModel,e),null!==o.callback&&o.callback.call()}}},t.prototype.setOptions=function(t){t&&t.hasOwnProperty("channel")&&""!==t.channel&&(this.network=postal.channel(t.channel)),t&&t.hasOwnProperty("viewmodelDirectory")&&(this.viewmodelDirectory=t.viewmodelDirectory),t&&t.hasOwnProperty("viewDirectory")&&(this.viewDirectory=t.viewDirectory)},t.prototype.getDOMElements=function(t){var e="."===t.substr(0,1)?"class":"id",n=t.replace(/[\.#]/,""),i=[];if("class"===e){var r=document.getElementsByClassName(n);if(r.length)for(var s in r)"object"==typeof r[s]&&(i[i.length]=r[s])}else"id"===e&&(i[i.length]=document.getElementById(n));if(null===i[i.length-1])throw new o("The DOM element you specified ("+t+") for view model `"+this.currentLocation+"` was not found.");return i},t.prototype.loadViewModel=function(t){var e=Q.defer(),i=this.federation.filter(function(e){return e.id===t})[0];return i?e.resolve(i):(console.warn(new n("Location with id `"+t+"` has not joined the federation. Attempting to join in now.")),require([this.viewmodelDirectory+"/"+t+".js"],function(t){this.join(t),e.resolve(t)}.bind(this))),e.promise},t.prototype.join=function(t){t.hasOwnProperty("__joined")?t.hasOwnProperty("__parent")||console.warn("The view model with id `"+t.id+"` has already joined the federation."):(t.hasOwnProperty("children")&&t.children.length>0&&t.children.map(function(e){e.__parent=t.id}),t.hasOwnProperty("__loaded")||(t.__loaded=!1),t.hasOwnProperty("show")||(t.show=function(){this.render(viewModel.id)}.bind(this)),t.__joined=!0,this.federation.push(t),this.network.publish(t.id+".joined"))},t.prototype.loadTemplate=function(t){var e=Q.defer(),n=this.federation.filter(function(e){return e.id===t})[0];if(n)if(n.__loaded)this.network.publish(n.id+".bound"),e.resolve(n);else{var i=[this.viewDirectory,"/",n.templatePath].join("");this.getDOMElements(n.domBindingId).forEach(function(t){var o=new XMLHttpRequest;o.open("GET",i,!0),o.onloadend=function(i){(200===i.target.status||302===i.target.status)&&(t.innerHTML=i.target.responseText,ko.applyBindings(n,t),n.__loaded=!0,this.network.publish(n.id+".bound"),e.resolve(n))}.bind(this),o.send()}.bind(this))}return e.promise},t.prototype.hideInactiveViews=function(t){return this.federation.forEach(function(e){e.autoRender||e.id===t.id||this.getDOMElements(e.domBindingId).forEach(function(t){t.style.display="none"})}.bind(this)),t},t.prototype.renderChildren=function(t){var e=Q.defer();return t.hasOwnProperty("children")&&t.children.map(function(t){this.render(t.id)}.bind(this)),e.promise},t.prototype.showRoutedView=function(t,e){this.getDOMElements(t.domBindingId).forEach(function(t){t.style.display=""}),this.network.publish(t.id+".docked",e)},t.prototype.render=function(t,e){this.loadViewModel(t).then(function(t){this.hideInactiveViews(t),this.loadTemplate(t.id).then(function(t){this.renderChildren(t),this.showRoutedView(t,e)}.bind(this))}.bind(this)).fail(function(t){console.error(t)}).catch(function(t){console.error(t)})};var e=function(){this.routes=[],this.currentLocation=null,this.smuggledPayload=null};e.prototype.getPayload=function(){return this.smuggledPayload},e.prototype.updateRoute=function(t){var e=this.routes.filter(function(e){return e.pattern===t.pattern})[0];e.callback=t.callback},e.prototype.addRoute=function(t){return this.routes[this.routes.length]={pattern:t.pattern,viewModel:t.viewmodelId,callback:t.callback},this.routes},e.prototype.warp=function(t){var e,n,i=[];try{if(t&&"string"==typeof t)n=t;else{if(t&&"object"==typeof t&&!t.hasOwnProperty("location"))throw new MissingOptionException("You must provide a location property and a payload property when publishing the `transport` event with an object parameter.");t&&"object"==typeof t&&t.hasOwnProperty("location")&&(n=t.location)}e=this.routes.filter(function(t){return t.pattern===n})[0],i[i.length]=n,t.hasOwnProperty("payload")&&t.payload&&(this.smuggledPayload=t.payload),history.pushState(null,null,i.join(""))}catch(t){console.error(t)}return e},e.prototype.scan=function(){var t,e,n={},i=location.pathname.split("/")[1];t=i,""!==i&&(e=i.split("/"),t=e[0],e.splice(0,1));var o=this.routes.filter(function(e){return e.pattern.split("/")[0]===t})||!1;if(o&&(o=o.filter(function(t){return i.split("/").length===t.pattern.split("/").length})||!1),o&&o.length&&e&&e.length){var r=o[0].pattern.split("/");r.splice(0,1);var s=0;for(r.length;arg=r[s];s+=1)":"===arg.substr(0,1)&&(n[arg.substr(1,arg.length-1)]=e[s])}if(o&&o.length)for(var a in n)this.smuggledPayload[a]=n[a];return o};var n=function(t){this.message=t,this.name="UnregisteredViewWarning"},i=function(t){this.message=t,this.name="MissingViewModelException"},o=function(t){this.message=t,this.name="MissingDOMElementException"};return new t});