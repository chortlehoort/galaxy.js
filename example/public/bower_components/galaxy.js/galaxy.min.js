define(["q","knockout","postal"],function(t,e,n){var i=function(t){this.message=t;this.name="UnregisteredViewWarning"};var o=function(t){this.message=t;this.name="MissingViewModelException"};var r=function(t){this.message=t;this.name="MissingDOMElementException"};var a=function(t){this.message=t;this.name="MissingOptionException"};var s=function(t){this.network=n.channel("galaxy");this.viewmodelDirectory="/app/viewmodel";this.viewDirectory="/app/view";this.federation=[];this.currentLocation=null;this.StarChart=this.StarChartConstructor()};s.prototype.route=function(t){var e={pattern:t,viewmodelId:null,callback:null};return{to:function(t){e.viewmodelId=t;this.StarChart.addRoute(e);return{then:function(t){e.callback=t;this.StarChart.updateRoute(e)}.bind(this)}}.bind(this)}};s.prototype.warp=function(){var t={};var e=function(){this.StarChart.warp(t)}.bind(this);return{to:function(n){t.location=n;return{engage:e,with:function(n){t.payload=n;return{engage:e}}}}}};s.prototype.create=function(t){if(t){this.setOptions(t)}requirejs.onError=function t(e){console.error(new o("Unable to find the location of `"+this.currentLocation+".js`. "+e.message))}.bind(this);this.StarChart.scan();window.addEventListener("popstate",function t(e){this.StarChart.scan()}.bind(this))};s.prototype.setOptions=function(t){if(t&&t.hasOwnProperty("channel")&&t.channel!==""){this.network=n.channel(t.channel)}if(t&&t.hasOwnProperty("viewmodelDirectory")){this.viewmodelDirectory=t.viewmodelDirectory}if(t&&t.hasOwnProperty("viewDirectory")){this.viewDirectory=t.viewDirectory}};s.prototype.getDOMElements=function(t){var e=t.substr(0,1)==="."?"class":"id";var n=t.replace(/[\.#]/,"");var i=[];if(e==="class"){var o=document.getElementsByClassName(n);if(o.length){for(var a in o){if(typeof o[a]==="object"){i[i.length]=o[a]}}}}else if(e==="id"){i[i.length]=document.getElementById(n)}if(i[i.length-1]===null){throw new r("The DOM element you specified ("+t+") for view model `"+this.currentLocation+"` was not found.")}return i};s.prototype.loadViewModel=function(e){var n=t.defer();var o=this.federation.filter(function(t){return t.id===e})[0];if(!o){console.warn(new i("Location with id `"+e+"` has not joined the federation. Attempting to join in now."));require([this.viewmodelDirectory+"/"+e+".js"],function t(e){this.join(e);n.resolve(e)}.bind(this))}else{n.resolve(o)}return n.promise};s.prototype.join=function(t){if(!t.hasOwnProperty("__joined")){if(t.hasOwnProperty("children")&&t.children.length>0){t.children.map(function(e){e.__parent=t.id})}if(!t.hasOwnProperty("__loaded")){t.__loaded=false}if(!t.hasOwnProperty("show")){t.show=function(){this.render(viewModel.id)}.bind(this)}t.__joined=true;this.federation.push(t);this.network.publish(t.id+".joined")}else{if(!t.hasOwnProperty("__parent")){console.warn("The view model with id `"+t.id+"` has already joined the federation.")}}};s.prototype.leave=function(t){var e=_.findWhere(this.federation,{id:t});if(e){this.federation=_.filter(this.federation,function(e){e.id!==t})}};s.prototype.loadTemplate=function(n){var i=t.defer();var o=this.federation.filter(function(t){return t.id===n})[0];if(o){if(!o.__loaded){var r=[this.viewDirectory,"/",o.templatePath].join("");this.getDOMElements(o.domBindingId).forEach(function(t){var n=new XMLHttpRequest;n.open("GET",r,true);n.onloadend=function n(r){if(r.target.status===200||r.target.status===302){t.innerHTML=r.target.responseText;e.applyBindings(o,t);o.__loaded=true;this.network.publish(o.id+".bound");i.resolve()}}.bind(this);n.send()}.bind(this))}else{this.network.publish(o.id+".bound");i.resolve()}}return i.promise};s.prototype.hideInactiveViews=function(t){this.federation.forEach(function(e){if(!e.autoRender&&e.id!==t){this.getDOMElements(e.domBindingId).forEach(function(t){t.style.display="none"})}}.bind(this))};s.prototype.render=function(t,e){var n=null;this.loadViewModel(t).then(function(e){n=e;this.hideInactiveViews(t);return this.loadTemplate(t)}.bind(this)).then(function(){this.getDOMElements(n.domBindingId).forEach(function(t){t.style.display=""});this.network.publish(n.id+".docked",e);if(n.hasOwnProperty("children")){n.children.map(function(t){this.render(t.id)})}}.bind(this)).fail(function(t){console.error(t)}).catch(function(t){console.error(t)}).finally(function(){})};s.prototype.StarChartConstructor=function(){var t=this;var e=function(){this.routes=[];this.currentLocation=null;this.smuggledPayload=null};e.prototype.updateRoute=function(t){var e=this.routes.filter(function(e){return e.pattern===t.pattern})[0];e.callback=t.callback};e.prototype.addRoute=function(t){this.routes[this.routes.length]={pattern:t.pattern,viewModel:t.viewmodelId,callback:t.callback};return this.routes};e.prototype.warp=function(t){var e=[];var n;var i;try{if(t&&typeof t==="string"){i=t}else if(t&&typeof t==="object"&&!t.hasOwnProperty("location")){throw new a("You must provide a location property and a payload property when publishing the `transport` event with an object parameter.")}else if(t&&typeof t==="object"&&t.hasOwnProperty("location")){i=t.location}n=this.routes.filter(function(t){return t.pattern===i})[0];e[e.length]=i;if(t.hasOwnProperty("payload")&&t.payload){this.smuggledPayload=t.payload}window.location.hash=e.join("")}catch(t){console.error(t)}return n};e.prototype.scan=function(e){var n={};var i,o,r;var a=location.hash.split("#")[1]||"";i=a;if(a!==""){o=a.split("/");i=o[0];o.splice(0,1)}var s=this.routes.filter(function(t){return t.pattern.split("/")[0]===i})||false;if(s){s=s.filter(function(t){return a.split("/").length===t.pattern.split("/").length})||false}if(s&&s.length&&o&&o.length){var l,c=s[0].pattern.split("/");c.splice(0,1);for(var h=0,d=c.length;h<=d,l=c[h];h+=1){if(l.substr(0,1)===":"){n[l.substr(1,l.length-1)]=o[h]}}}if(s&&s.length){for(var f in this.smuggledPayload){n[f]=this.smuggledPayload[f]}t.render(s[0].viewModel,n);if(s[0].callback!==null){s[0].callback.call()}}};return new e};s.prototype.depot=function(){var n=function(){this.collection=e.observableArray();this.proxy=null;this._dirty=false};n.prototype.populate=function(e){var n=t.defer();if(!this._dirty&&this.collection().length&&!e){n.resolve()}else if(!this._dirty||e){this.proxy.load().then(function(t){this.collection(t);n.resolve()}.bind(this)).fail(function(t){console.log("Failed to load from remote proxy. "+t.toString());n.reject()}).done()}else{n.reject()}return n.promise};n.prototype.isDirty=function(){return this._dirty};n.prototype.sync=function(){this.collection.forEach(function(t){if(t.hasOwnProperty("_local")&&t._local){this.proxy.save(t).then(function(){t._local=false}).fail(function(t){console.error(t)}).done()}}.bind(this))};n.prototype.add=function(t){if(t instanceof Array){t.forEach(function(t){this.collection.push(t)}.bind(this))}else{this.collection.push(t)}};n.prototype.empty=function(){this.collection.removeAll()};n.prototype.remove=function(t){var e=this.collection().filter(function(e){return JSON.stringify(e)!==JSON.stringify(t)});this.collection(e)};n.prototype.removeById=function(t){var e=this.collection().filter(function(e){return e.id!==t});this.collection(e)};return new n};return new s});
//# sourceMappingURL=./galaxy.map