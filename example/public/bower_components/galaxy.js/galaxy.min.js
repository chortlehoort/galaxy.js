define(["q","knockout","postal"],function(t,e,n){var o=function(t){this.message=t;this.name="DuplicateViewRegistrationException"};var i=function(t){this.message=t;this.name="UnregisteredViewWarning"};var r=function(t){this.message=t;this.name="MissingViewModelException"};var a=function(t){this.message=t;this.name="MissingDOMElementException"};var l=function(t){this.message=t;this.name="ViewLoadedException"};var s=function(t){this.message=t;this.name="MissingOptionException"};var c=function(t){this.network=n.channel("galaxy");this.viewmodelDirectory="/app/viewmodel";this.viewDirectory="/app/view";this.federation=[];this.currentLocation=null;this.StarChart=this.StarChartConstructor()};c.prototype.route=function(t){var e=this;var n={pattern:t,viewmodelId:null,callback:null};return{to:function(t){n.viewmodelId=t;e.StarChart.addRoute(n);return{then:function(t){n.callback=t;e.StarChart.updateRoute(n)}}}}};c.prototype.warp=function(){var t=this;var e={};var n=function(){t.StarChart.warp(e)};return{to:function(t){e.location=t;return{engage:n,with:function(t){e.payload=t;return{engage:n}}}}}};c.prototype.addRoute=function(t,e,n){this.StarChart.addRoute(t,e,n)};c.prototype.create=function(t){var e=this;if(t){e.setOptions(t)}requirejs.onError=function(t){console.error(new r("Unable to find the location of `"+e.currentLocation+".js`. "+t.message))};e.StarChart.scan();window.addEventListener("popstate",function(t){e.StarChart.scan()})};c.prototype.setOptions=function(t){if(t&&t.hasOwnProperty("channel")&&t.channel!==""){this.network=n.channel(t.channel)}if(t&&t.hasOwnProperty("viewmodelDirectory")){this.viewmodelDirectory=t.viewmodelDirectory}if(t&&t.hasOwnProperty("viewDirectory")){this.viewDirectory=t.viewDirectory}};c.prototype.getDOMElements=function(t){var e=t.substr(0,1)==="."?"class":"id";var n=t.replace(/[\.#]/,"");var o=[];if(e==="class"){var i=document.getElementsByClassName(n);if(i.length){for(var r in i){if(typeof i[r]==="object"){o[o.length]=i[r]}}}}else if(e==="id"){o[o.length]=document.getElementById(n)}if(o[o.length-1]===null){throw new a("The DOM element you specified ("+t+") for view model `"+this.currentLocation+"` was not found.")}return o};c.prototype.loadViewModel=function(e){var n=this;var o=t.defer();var r=n.federation.filter(function(t){return t.id===e})[0];if(!r){console.warn(new i("Location with id `"+e+"` has not joined the federation. Attempting to join in now."));require([n.viewmodelDirectory+"/"+e+".js"],function(t){n.join(t);o.resolve(t)})}else{o.resolve(r)}return o.promise};c.prototype.join=function(t){var e=this;if(!t.hasOwnProperty("__joined")){if(t.hasOwnProperty("children")&&t.children.length>0){t.children.map(function(e){e.__parent=t.id})}if(!t.hasOwnProperty("__loaded")){t.__loaded=false}if(!t.hasOwnProperty("show")){t.show=function(){e.render(this.id)}}t.__joined=true;e.federation.push(t);this.network.publish(t.id+".joined")}else{if(!t.hasOwnProperty("__parent")){console.warn("The view model with id `"+t.id+"` has already joined the federation.")}}};c.prototype.leave=function(t){var e=_.findWhere(this.federation,{id:t});if(e){this.federation=_.filter(this.federation,function(e){e.id!==t})}};c.prototype.loadTemplate=function(n){var o=this;var i=t.defer();var r=o.federation.filter(function(t){return t.id===n})[0];if(r){if(!r.__loaded){var a=[this.viewDirectory,"/",r.templatePath].join("");o.getDOMElements(r.domBindingId).forEach(function(t){var n=new XMLHttpRequest;n.open("GET",a,true);n.onloadend=function(n){if(n.target.status===200||n.target.status===302){t.innerHTML=n.target.responseText;e.applyBindings(r,t);r.__loaded=true;o.network.publish(r.id+".bound");i.resolve()}};n.send()})}else{this.network.publish(r.id+".bound");i.resolve()}}return i.promise};c.prototype.hideInactiveViews=function(t){var e=this;e.federation.forEach(function(n){if(!n.autoRender&&n.id!==t){e.getDOMElements(n.domBindingId).forEach(function(t){t.style.display="none"})}})};c.prototype.render=function(t,e){var n=this;var o=null;n.loadViewModel(t).then(function(e){o=e;n.hideInactiveViews(t);return n.loadTemplate(t)}).then(function(){n.getDOMElements(o.domBindingId).forEach(function(t){t.style.display=""});n.network.publish(o.id+".docked",e);if(o.hasOwnProperty("children")){o.children.map(function(t){n.render(t.id)})}}).fail(function(t){console.error(t)}).catch(function(t){console.error(t)}).finally(function(){})};c.prototype.StarChartConstructor=function(){var t=this;var e=function(){this.routes=[];this.currentLocation=null;this.smuggledPayload=null};e.prototype.updateRoute=function(t){var e=this.routes.filter(function(e){return e.pattern===t.pattern})[0];e.callback=t.callback};e.prototype.addRoute=function(t){this.routes[this.routes.length]={pattern:t.pattern,viewModel:t.viewmodelId,callback:t.callback};return this.routes};e.prototype.warp=function(t){var e=[];var n;var o;try{if(t&&typeof t==="string"){o=t}else if(t&&typeof t==="object"&&!t.hasOwnProperty("location")){throw new s("You must provide a location property and a payload property when publishing the `transport` event with an object parameter.")}else if(t&&typeof t==="object"&&t.hasOwnProperty("location")){o=t.location}n=this.routes.filter(function(t){return t.pattern===o})[0];e[e.length]=o;if(t.hasOwnProperty("payload")&&t.payload){this.smuggledPayload=t.payload}window.location.hash=e.join("")}catch(t){console.error(t)}return n};e.prototype.scan=function(e){var n=this;var o={};var i,r,a;var l=location.hash.split("#")[1]||"";i=l;if(l!==""){r=l.split("/");i=r[0];r.splice(0,1)}var s=n.routes.filter(function(t){return t.pattern.split("/")[0]===i})||false;if(s){s=s.filter(function(t){return l.split("/").length===t.pattern.split("/").length})||false}if(s&&s.length&&r&&r.length){var c=s[0].pattern.split("/");c.splice(0,1);for(var f=0,u=c.length;f<=u,arg=c[f];f+=1){if(arg.substr(0,1)===":"){o[arg.substr(1,arg.length-1)]=r[f]}}}if(s&&s.length){for(var h in n.smuggledPayload){o[h]=n.smuggledPayload[h]}t.render(s[0].viewModel,o);if(s[0].callback!==null){s[0].callback.call()}}};return new e};c.prototype.depot=function(){var n=function(){this.collection=e.observableArray();this.proxy=null;this._dirty=false};n.prototype.populate=function(e){var n=t.defer();var o=this;if(!o._dirty&&o.collection().length&&!e){n.resolve()}else if(!o._dirty||e){o.proxy.load().then(function(t){o.collection(t);n.resolve()}).fail(function(t){console.log("Failed to load from remote proxy. "+t.toString());n.reject()}).done()}else{n.reject()}return n.promise};n.prototype.isDirty=function(){return this._dirty};n.prototype.sync=function(){var t=this;t.collection.forEach(function(e){if(e.hasOwnProperty("_local")&&e._local){t.proxy.save(e).then(function(){e._local=false}).fail(function(t){console.error(t)}).done()}})};n.prototype.add=function(t){var e=this;if(t instanceof Array){t.forEach(function(t){e.collection.push(t)})}else{e.collection.push(t)}};n.prototype.empty=function(){this.collection.removeAll()};n.prototype.remove=function(t){var e=this.collection().filter(function(e){return JSON.stringify(e)!==JSON.stringify(t)});this.collection(e)};n.prototype.removeById=function(t){var e=this.collection().filter(function(e){return e.id!==t});this.collection(e)};return new n};return new c});
//# sourceMappingURL=./galaxy.map